<html lang="en">
<head>
    <title>SoBi Maps</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyABjNtIFN8YQ3Fxs0JsPP6XVczHIDk623Q&libraries=places,geometry"></script>
    <!--<script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=true"></script>-->
    <script type="text/javascript" src="hubs.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <!--AIzaSyABjNtIFN8YQ3Fxs0JsPP6XVczHIDk623Q -->
    <!-- AIzaSyCzJIZBUAYgpWfSAOCwFznJV1VfAZnaml0 -->
    <style type="text/css">
        body {
            background-color: #ccf5ff;
        }

        form {
            margin-top: 1em;
        }

        h1 {
            text-align: center;
        }

        label {
            padding: 0;
        }

        #map{
            height: 650px;
            background:#6699cc;
        }

        #right-panel{
            height: 650px;
            background-color: white;
            overflow-y: scroll;
        }

        #infoWindow{
            height: 500px;
            background: lightgreen;
            display: none;
        }

        #mapsLink, .iwMapsLink{
            font-style: italic;
        }

        #linkContainer{
            text-align: center;
        }

        .title{
            padding-top: 10px;
            font-size: 24pt;
            text-align: center;
        }

        .subtitle{
            font-size: 18pt;
            text-align: center;
        }

        #help {
            background-color: skyblue;
            width: 100vw;
            border: 3px solid blue;
        }

        .info {
            font-weight: bold;
        }

        #minRacks{
            user-select: none;
        }

        .topcorner{
            position: absolute;
            top: 5px;
            right: 5px;
        }

        #back {
            width: 50px;
            height: 50px;
            margin-left: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            visibility: hidden;
        }

        #right-panel {
            visibility: hidden;
        }

        .adp-warnbox, .adp-legal{
            display: none;
        }

        .adp-marker2 {
            content: url("https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|FE7569");
        }

        #right-panel-waypoints .adp-text, #right-panel-waypoints .adp-marker2 {
            display: none;
        }

        .form-signin{
            display: none;
        }
    </style>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script>
        var latitude;
        var longitude;
        var map;
        var hubMarkers = [];
        var waypoints = [];
        var openedInfoWindow;
        var originAutocomplete;
        var destinationAutocomplete;
        var startMarker;
        var destinationMarker;

        $(document).ready(function(){
            navigator.geolocation.getCurrentPosition(
                function(position){
                    latitude = position.coords.latitude;
                    longitude = position.coords.longitude;
                    var coords = {lat: latitude, lng: longitude};
                    map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 11,
                        center: coords
                    });

                    var mapsURL = "https://www.google.com/maps?q=" + encodeURI(latitude + "," + longitude);

                    var marker = new google.maps.Marker({
                        position: coords,
                        map: map
                    });

                    var infowindow = new google.maps.InfoWindow({
                        content: "<p>Current Location</p>" +
                        "<a class='iwMapsLink' target='_blank' " + "href='" + mapsURL + "'>" +
                        "Open in Google Maps" +
                        "</a>"
                    });

                    marker.addListener('click', function() {
                        if (openedInfoWindow != undefined){
                            openedInfoWindow.close();
                        }
                        openedInfoWindow = infowindow;
                        infowindow.open(map, marker);
                    });
                    pinHubs(map);
                    new AutocompleteDirectionsHandler(map);
                    //var startLatLng = new google.maps.LatLng({lat: 43.2583192006676, lng: -79.8424060642719});
                    //var destLatLng = new google.maps.LatLng({lat: 43.2551792486624, lng: -79.8614431097373});
                    //console.log(google.maps.geometry.spherical.computeDistanceBetween(startLatLng,destLatLng));
                },
                function(error) {
                    latitude = 43.255203;
                    longitude = -79.843826;
                    var coords = {lat: latitude, lng: longitude};
                    map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 11,
                        center: coords
                    });
                    pinHubs(map);
                    new AutocompleteDirectionsHandler(map);
                }
            );

            $("form").submit(function(){
                return false;
            });

            $("#back").click(function(){
                location.reload();
            });

            $("#signIn").click(function(){
                /*$.ajax({
                    url: "backend.php",
                    type: "post",
                    error: function(){
                        alert("something bad happened");
                     },
                    success: function(result) {
                        alert(result);
                    }
                });*/

                $(".form-signin").css("display", "block");
            });

            $("#signInButton").click(function(){
                $.ajax({
                    url: "php/signin.php",
                    data: {
                        username: $("#username").val().trim(),
                        password: $("#password").val().trim(),
                    },
                    type: "post",
                    error: function(){
                        alert("something bad happened");
                    },
                    success: function(result) {
                        alert(result);
                    }
                });
            });

            $("#minRacks").change(function(){
                var minRacks = parseInt($(this).val());
                hideMarkers(minRacks);
                if ($("#start").val().trim() != ""
                    && $("#destination").val().trim() != ""){
                    google.maps.event.trigger(originAutocomplete, 'place_changed');
                    //google.maps.event.trigger(destinationAutocomplete, 'place_changed');
                }
            });
        });

        function pinHubs(map){
            for (var i = 0; i < hubs.length; i++){
                var hub = hubs[i];
                var colour;
                if (hub.racks >= 5 && hub.racks <= 9){
                    colour = "b3d1ff";
                } else if (hub.racks >= 10 && hub.racks <= 14){
                    colour = "80b3ff";
                } else if (hub.racks >= 15 && hub.racks <= 19){
                    colour = "3385ff";
                } else {
                    colour = "0052cc";
                }

                var marker = new google.maps.Marker({
                    position: {lat: parseFloat(hub.latitude), lng: parseFloat(hub.longitude)},
                    map: map,
                    racks: hub.racks,
                    icon: ('https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=' + hub.racks + '|' + colour)
                });

                google.maps.event.addListener(marker, 'click', (function(marker, hubs) {
                    return function() {
                        var mapsURL = "https://www.google.com/maps?q=" + encodeURI(hubs.address);

                        var infowindow = new google.maps.InfoWindow({
                            content: "<p class='hubName'></p>" +
                            "<a class='iwMapsLink' target='_blank'>" +
                            "Open in Google Maps" +
                            "</a>"
                        });
                        infowindow.open(map, marker);
                        if (openedInfoWindow != undefined){
                            openedInfoWindow.close();
                        }
                        openedInfoWindow = infowindow;

                        /*$("#map").width("100%");
                        $("#infoWindow").css("display","block");
                        $("#name").html(hubs.name);
                        $("#address").html(hubs.address);
                        $("#latitude").html(hubs.latitude);
                        $("#longitude").html(hubs.longitude);
                        $("#racks").html(hubs.racks);
                        $("#mapsLink").attr("href", mapsURL);*/
                        $(".iwMapsLink").attr("href", mapsURL);
                        $(".hubName").html(hubs.name);

                        //map.setCenter(hubs.latitude, hubs.longitude);
                        //map.setZoom(16);

                        /*if ($(window).width() < 768){
                            $('html, body').animate({
                                scrollTop: $("#infoWindow").offset().top
                            }, 1000 );
                        }*/
                    }
                })(marker, hubs[i]));
                hubMarkers.push(marker);
            }
        }

        // AutocompleteDirectionsHandler retrieved from :
        //https://developers.google.com/maps/documentation/javascript/examples/places-autocomplete-directions
        function AutocompleteDirectionsHandler(map) {
            this.map = map;
            this.originPlaceId = null;
            this.destinationPlaceId = null;
            this.travelMode = 'WALKING';
            var originInput = document.getElementById('start');
            var destinationInput = document.getElementById('destination');
            //var modeSelector = document.getElementById('mode-selector');
            this.directionsService = new google.maps.DirectionsService;
            this.directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true, polylineOptions: {strokeColor: "blue"}, preserveViewport: true});
            this.directionsDisplayWaypoints = new google.maps.DirectionsRenderer({suppressMarkers: true, polylineOptions: {strokeColor: "red"}, preserveViewport: true});
            this.directionsDisplayEnd = new google.maps.DirectionsRenderer({suppressMarkers: true, polylineOptions: {strokeColor: "green"}, preserveViewport: true});
            this.directionsDisplay.setMap(map);
            this.directionsDisplayWaypoints.setMap(map);
            this.directionsDisplayEnd.setMap(map);

            this.directionsDisplay.setPanel(document.getElementById('right-panel-start'));
            this.directionsDisplayWaypoints.setPanel(document.getElementById('right-panel-waypoints'));
            this.directionsDisplayEnd.setPanel(document.getElementById('right-panel-end'));

            originAutocomplete = new google.maps.places.Autocomplete(
                originInput, {placeIdOnly: false});
            destinationAutocomplete = new google.maps.places.Autocomplete(
                destinationInput, {placeIdOnly: false});

            //this.setupClickListener('changemode-walking', 'WALKING');
            //this.setupClickListener('changemode-transit', 'TRANSIT');
            //this.setupClickListener('changemode-driving', 'DRIVING');

            this.setupPlaceChangedListener(originAutocomplete, 'ORIG');
            this.setupPlaceChangedListener(destinationAutocomplete, 'DEST');

            //this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(originInput);
            //this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(destinationInput);
            //this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(modeSelector);
        }

        AutocompleteDirectionsHandler.prototype.setupPlaceChangedListener = function(autocomplete, mode) {
            var me = this;
            autocomplete.bindTo('bounds', this.map);
            autocomplete.addListener('place_changed', function() {
                var place = autocomplete.getPlace();

                if (!place.place_id) {
                    window.alert("Please select an option from the dropdown list.");
                    return;
                }
                if (mode === 'ORIG') {
                    me.originPlaceId = place.place_id;
                    me.startLatLng = new google.maps.LatLng({
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    });
                } else {
                    me.destinationPlaceId = place.place_id;
                    me.destLatLng = new google.maps.LatLng({
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    });
                }
                me.route(me.startLatLng, me.destLatLng);
                if (me.startLatLng && me.destLatLng){
                    var bounds = new google.maps.LatLngBounds();
                    bounds.extend(me.startLatLng);
                    bounds.extend(me.destLatLng);
                    map.fitBounds(bounds);
                }
            });

        };

        AutocompleteDirectionsHandler.prototype.route = function(startLatLng, destLatLng) {
            if (!this.originPlaceId || !this.destinationPlaceId) {
                return;
            }

            var minRacks = parseInt($("#minRacks").val());
            hideMarkers(minRacks);

            if (startMarker != undefined){
                startMarker.setMap(null);
            }
            if (destinationMarker != undefined){
                destinationMarker.setMap(null);
            }

            var me = this;
            var waypointA;
            var waypointB;

            for (var i = 0; i < hubMarkers.length; i++){
                var hub = hubMarkers[i];
                var hubLatLng = new google.maps.LatLng({
                    lat: hub.position.lat(),
                    lng: hub.position.lng()
                });
                var distance = google.maps.geometry.spherical
                    .computeDistanceBetween(startLatLng, hubLatLng);

                if ((!waypointA || (distance < waypointA.distance))
                    && hub.getMap() != null){
                    waypointA = {
                        latlng: hubLatLng,
                        distance: distance,
                        marker: hub
                    };
                }
            }

            for (var i = 0; i < hubMarkers.length; i++){
                var hub = hubMarkers[i];
                var hubLatLng = new google.maps.LatLng({
                    lat: hub.position.lat(),
                    lng: hub.position.lng()
                });
                var distance = google.maps.geometry.spherical
                    .computeDistanceBetween(destLatLng, hubLatLng);

                if ((!waypointB || (distance < waypointB.distance))
                    && hub.getMap() != null){
                    waypointB = {
                        latlng: hubLatLng,
                        distance: distance,
                        marker: hub
                    };
                }
            }
            console.log(waypointA.latlng.lat() + ", " + waypointA.latlng.lng());
            console.log(waypointB.latlng.lat() + ", " + waypointB.latlng.lng());
            waypoints = [];
            waypoints.push({
                location: waypointA.latlng,
                stopover: true
            });
            waypoints.push({
                location: waypointB.latlng,
                stopover: true
            });


            this.directionsService.route({
                origin: {'placeId': this.originPlaceId},
                destination: waypointA.latlng,
                travelMode: 'TRANSIT'
            }, function(response, status) {
                if (status === 'OK') {
                    me.directionsDisplay.setDirections(response);

                    showMarkers();
                    showWaypoints(waypointA.marker, waypointB.marker);

                    $("#back").css("visibility", "visible");

                    startMarker = new google.maps.Marker({
                        position: startLatLng,
                        map: map,
                        icon: ('https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=S|ffff00')
                    });


                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });

            this.directionsService.route({
                origin: waypointA.latlng,
                destination: waypointB.latlng,
                travelMode: 'BICYCLING'
            }, function(response, status) {
                if (status === 'OK') {
                    me.directionsDisplayWaypoints.setDirections(response);

                    showMarkers();
                    showWaypoints(waypointA.marker, waypointB.marker);

                    $("#back").css("visibility", "visible");
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });

            this.directionsService.route({
                origin: waypointB.latlng,
                destination: {'placeId': this.destinationPlaceId},
                travelMode: 'TRANSIT'
            }, function(response, status) {
                if (status === 'OK') {
                    me.directionsDisplayEnd.setDirections(response);

                    showMarkers();
                    showWaypoints(waypointA.marker, waypointB.marker);

                    $("#back").css("visibility", "visible");

                    destinationMarker = new google.maps.Marker({
                        position: destLatLng,
                        map: map,
                        icon: ('https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=D|00ff00')
                    });
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });

            $("#map-container").removeClass("col-lg-12 col-md-12 col-sm-12");
            $("#map-container").addClass("col-lg-9 col-md-9 col-sm-8");
            $("#right-panel").css("visibility", "visible");
        };

        function showWaypoints(waypointA, waypointB){
            var waypoints = [waypointA, waypointB];
            for (var i = 0; i < hubMarkers.length; i++) {
                if (!waypoints.includes(hubMarkers[i])){
                    hubMarkers[i].setMap(null);
                }
            }
        }

        function hideMarkers(minRacks){
            showMarkers();
            for (var i = 0; i < hubMarkers.length; i++) {
                var hubRacks = parseInt(hubMarkers[i].racks);
                if (minRacks > hubRacks){
                    hubMarkers[i].setMap(null);
                }
            }
        }

        function showMarkers(){
            for (var i = 0; i < hubMarkers.length; i++) {
                hubMarkers[i].setMap(map);
            }
        }
    </script>
</head>
<body>
<form class="form-horizontal container-fluid">
    <div class="row">
        <div class="col-lg-2 col-md-2 col-sm-2">
            <h1>SoBi Maps</h1>
        </div>
        <div class="col-lg-6 col-md-6 col-sm-6">
            <div class="form-group">
                <label for="start" class="control-label col-sm-3">Start:</label>
                <div class="col-sm-9">
                    <input type="text" class="form-control input-sm" id="start">
                </div>
            </div>
            <div class="form-group">
                <label for="destination" class="control-label col-sm-3">Destination:</label>
                <div class="col-sm-9">
                    <input type="text" class="form-control input-sm" id="destination">
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-4 col-sm-4">
            <div class="form-group">
                <label for="racks" class="control-label col-lg-2 col-md-2 col-sm-3" style="padding-right: 0;">Racks:</label>
                <div class="col-lg-10 col-md-10 col-sm-9" style="display: inline-block; margin-right: 0; margin-left: 0;">
                    <input type="number" value="5" step="1" min="5" max="25" class="form-control input-sm col-lg-4 col-md-4 col-sm-4 col-xs-4" id="minRacks" style="width: 55px; margin-right: 1em;">
                    <span class="" style="">or more</span>
                </div>
            </div>
        </div>
        <div class="topcorner">
            <div><a id="signIn" href="#">Sign in</a></div>
            <div><a href="signUp.html">Sign up</a></div>
            <div><a href="#">Help</a></div>
        </div>
    </div>
</form>

<div class="row container-fluid" style="margin: 0; padding: 0;">
    <div class="col-lg-4 col-md-4 col-sm-4">
        <img id="back" src="back.png">
    </div>

    <div class="col-lg-4 col-md-4 col-sm-4 form-signin">
        <h2 class="form-signin-heading">Please sign in</h2>
        <label for="username" class="sr-only">Username</label>
        <input type="text" id="username" class="form-control" placeholder="Username" required autofocus>
        <label for="password" class="sr-only">Password</label>
        <input type="password" id="password" class="form-control" placeholder="Password" required>
        <button id="signInButton" class="btn btn-lg btn-primary btn-block" type="submit">Sign in</button>
        <br />
    </div>
</div>

<div class="row container-fluid" style="margin: 0; padding: 0;">
    <div id="map-container" class="col-lg-12 col-md-12 col-sm-12" style="padding: 0;">
        <div id="map" style="padding: 0;"></div>
    </div>
    <div id="right-panel" class="col-lg-3 col-md-3 col-sm-4">
        <div id="right-panel-start"></div>
        <div id="right-panel-waypoints"></div>
        <div id="right-panel-end"></div>
    </div>
    <!--<div class="col-lg-3 col-md-3 col-sm-4" style="padding: 0;">
        <div id="infoWindow" style="padding: 0;">
            <div class="title">Location Info</div><br /><br />
            <div class="row container-fluid">
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 info">Name: </div>
                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8" id="name"></div>
            </div>
            <br /><br />
            <div class="row container-fluid">
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 info">Address: </div>
                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8" id="address"></div>
            </div>
            <br /><br />
            <div class="row container-fluid">
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 info">Latitude: </div>
                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8" id="latitude"></div>
            </div>
            <br /><br />
            <div class="row container-fluid">
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 info">Longitude: </div>
                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8" id="longitude"></div>
            </div>
            <br /><br />
            <div class="row container-fluid">
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 info">Racks: </div>
                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8" id="racks"></div>
            </div>
            <br /><br />
            <div id="linkContainer"><a id="mapsLink" target="_blank">Open in Google Maps</a></div>
        </div>
    </div>-->
</div>
<div class="row container-fluid" style="margin: 0; padding: 0;">
    <div id="help" style="padding: 20px; text-align: center; font-size: 13pt;">
        <div class="title">Help</div><br />
        <p>Welcome to SoBi Maps, the place to find all the different SoBi Bicycle Hubs across Hamilton.
            This website helps you find SoBi (Social Bicycle) hubs that are the closest to your starting and destination point.
        </p><br />

        <div class="subtitle">Search Options</div><br />
        <div style="text-align: left; display: table; margin: 0 auto;">
            <div class="info">Start: </div>
            <span>
						Your starting point, address or a place, must be in Hamilton, Ontario.
					</span>
            <br />
            <div class="info">Destination: </div>
            <span>
						Your destination point, address or a place, must be in Hamilton, Ontario.
					</span>
            <br />
            <div class="info">Racks: </div>
            <span>
						The minimum number of bike racks at a location, must be between 5 and 25 (eg, 5 or more bike racks).
					</span>
        </div>
        <br /><br />

        <div style="text-align: left; display: table; margin: 0 auto;">
            <div class="subtitle">Map Legend</div><br />
            <span><img src="https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|FE7569" />
					Your current location</span><br />
            <span><img src="https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=S|ffff00" />
					Starting point</span><br />
            <span><img src="https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=D|00ff00" />
					Destination point</span><br />
            <span><img src="https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=|b3d1ff" />
					A bike hub location with 5 or more bike racks</span><br />
            <span><img src="https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=|80b3ff" />
					A bike hub location with 10 or more bike racks</span><br />
            <span><img src="https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=|3385ff" />
					A bike hub location with 15 or more bike racks</span><br />
            <span><img src="https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=|0052cc" />
					A bike hub location with 20 or more bike racks</span><br />
        </div>
        <br />
        <p><strong>Click on any hub location to get more information such as latitude,
            longitude, and number of bike racks at the location.</strong></p>
        <p><strong>The number on the pins represent the number of bike racks at that hub.</strong></p>
    </div>
</div>

</body>
</html>